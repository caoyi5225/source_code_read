<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="api1export &amp;#123; Provider, createProvider, connectAdvanced, connect &amp;#125; 从 index.js 可以知道, react-redux对外暴露了4个api,接下来我们去看每个api的实现 Provider1234567891011121314151617181920212223242526272829303132333435">
<meta property="og:type" content="article">
<meta property="og:title" content="react-redux 源码解析">
<meta property="og:url" content="http://yoursite.com/2019/01/31/react-redux/index.html">
<meta property="og:site_name" content="Shadow&#39;s Blog">
<meta property="og:description" content="api1export &amp;#123; Provider, createProvider, connectAdvanced, connect &amp;#125; 从 index.js 可以知道, react-redux对外暴露了4个api,接下来我们去看每个api的实现 Provider1234567891011121314151617181920212223242526272829303132333435">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-01-31T04:45:27.891Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="react-redux 源码解析">
<meta name="twitter:description" content="api1export &amp;#123; Provider, createProvider, connectAdvanced, connect &amp;#125; 从 index.js 可以知道, react-redux对外暴露了4个api,接下来我们去看每个api的实现 Provider1234567891011121314151617181920212223242526272829303132333435">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>react-redux 源码解析</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/gabithume">Projects</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$("#i-top").toggle();" onmouseout="$("#i-top").toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$("#i-share").toggle();" onmouseout="$("#i-share").toggle();" onclick="$("#share").toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/01/31/react-redux/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/01/31/react-redux/&text=react-redux 源码解析"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/01/31/react-redux/&title=react-redux 源码解析"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/01/31/react-redux/&is_video=false&description=react-redux 源码解析"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=react-redux 源码解析&body=Check out this article: http://yoursite.com/2019/01/31/react-redux/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/01/31/react-redux/&title=react-redux 源码解析"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/01/31/react-redux/&title=react-redux 源码解析"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/01/31/react-redux/&title=react-redux 源码解析"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/01/31/react-redux/&title=react-redux 源码解析"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/01/31/react-redux/&name=react-redux 源码解析&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#api"><span class="toc-number">1.</span> <span class="toc-text">api</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Provider"><span class="toc-number">2.</span> <span class="toc-text">Provider</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#createProvider"><span class="toc-number">3.</span> <span class="toc-text">createProvider</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#connectAdvance"><span class="toc-number">4.</span> <span class="toc-text">connectAdvance</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Subscription"><span class="toc-number">5.</span> <span class="toc-text">Subscription</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        react-redux 源码解析
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">Shadow's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-01-31T04:40:10.000Z" itemprop="datePublished">2019-01-31</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="api"><a href="#api" class="headerlink" title="api"></a>api</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> &#123; Provider, createProvider, connectAdvanced, connect &#125;</span><br></pre></td></tr></table></figure>
<p>从 index.js 可以知道, react-redux对外暴露了4个api,接下来我们去看每个api的实现</p>
<h2 id="Provider"><a href="#Provider" class="headerlink" title="Provider"></a>Provider</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Provider</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Provider作为顶层组件,通过context向下分发store</span></span><br><span class="line">  <span class="comment">// 之后Connect组件可以获取store</span></span><br><span class="line">  getChildContext() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; [storeKey]: <span class="keyword">this</span>[storeKey], [subscriptionKey]: <span class="literal">null</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props, context) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props, context)</span><br><span class="line">    <span class="keyword">this</span>[storeKey] = props.store;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="comment">// 返回children里仅有的子级。否则抛出异常</span></span><br><span class="line">    <span class="comment">// Provider必须有且仅有一个子组件</span></span><br><span class="line">    <span class="keyword">return</span> Children.only(<span class="keyword">this</span>.props.children)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Provider.propTypes = &#123;</span><br><span class="line">  store: storeShape.isRequired,</span><br><span class="line">  children: PropTypes.element.isRequired,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Provider.childContextTypes = &#123;</span><br><span class="line">  [storeKey]: storeShape.isRequired,</span><br><span class="line">  [subscriptionKey]: subscriptionShape,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// store的格式</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> storeShape = PropTypes.shape(&#123;</span><br><span class="line">  subscribe: PropTypes.func.isRequired,</span><br><span class="line">  dispatch: PropTypes.func.isRequired,</span><br><span class="line">  getState: PropTypes.func.isRequired</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// subscription的格式</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> subscriptionShape = PropTypes.shape(&#123;</span><br><span class="line">  trySubscribe: PropTypes.func.isRequired,</span><br><span class="line">  tryUnsubscribe: PropTypes.func.isRequired,</span><br><span class="line">  notifyNestedSubs: PropTypes.func.isRequired,</span><br><span class="line">  isSubscribed: PropTypes.func.isRequired,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这里我们可以看到,Provider组件的作用就是作为根组件,向整个react树通过context分发store</p>
<h2 id="createProvider"><a href="#createProvider" class="headerlink" title="createProvider"></a>createProvider</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createProvider</span>(<span class="params">storeKey = <span class="string">'store'</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// createProvider为自定义storeKey的Provider提供了创建接口</span></span><br><span class="line">  <span class="keyword">const</span> subscriptionKey = <span class="string">`<span class="subst">$&#123;storeKey&#125;</span>Subscription`</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> Provider;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="connectAdvance"><a href="#connectAdvance" class="headerlink" title="connectAdvance"></a>connectAdvance</h2><p>因为connectAdvance的返回值是一个HOC(高阶组件),所以不熟悉HOC的话可以移步<a href="https://react.docschina.org/docs/higher-order-components.html" target="_blank" rel="noopener">HOC</a><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">connectAdvanced</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="regexp">/**</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">   * selectFactory 负责从state,props,dispath计算新的props</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">   * 定义方式如下:</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">   * options是传递给connectAdvance的第二个参数和WrappedComponent的组合</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">   * export default connectAdvanced((dispatch, options) =&gt; (state, props) =&gt; (&#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">   *   thing: state.things[props.thingId],</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">   *   saveThing: fields =&gt; dispatch(actionCreators.saveThing(props.thingId, fields)),</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">   * &#125;))(YourComponent)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">   */</span></span></span></span><br><span class="line"><span class="function"><span class="params">  selectorFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">  &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  </span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="regexp">//</span> 用来组织HOC的名字</span></span></span><br><span class="line"><span class="function"><span class="params">    getDisplayName = name =&gt; <span class="string">`ConnectAdvanced(<span class="subst">$&#123;name&#125;</span>)`</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="regexp">//</span> 错误提示时展示用的名字</span></span></span><br><span class="line"><span class="function"><span class="params">    methodName = <span class="string">'connectAdvanced'</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="regexp">//</span> 如果已定义,则指定对应的子组件的render次数</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="regexp">//</span> 用于在react-devtools观察不必要的render</span></span></span><br><span class="line"><span class="function"><span class="params">    renderCountProp = undefined,</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="regexp">//</span> 表明HOC是否订阅state改变</span></span></span><br><span class="line"><span class="function"><span class="params">    shouldHandleStateChanges = true,</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="regexp">//</span> 从context<span class="regexp">/props中获取store的key</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    storeKey = 'store',</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    /</span><span class="regexp">/ 是否需要ref,详见HOC介绍</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    withRef = false,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    /</span><span class="regexp">/ 其余的配置</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    ...connectOptions</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">  &#125; = &#123;&#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">  const subscriptionKey = storeKey + 'Subscription'</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">  /</span><span class="regexp">/ 热加载版本</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">  const version = hotReloadingVersion++</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">  const contextTypes = &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    [storeKey]: storeShape,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    [subscriptionKey]: subscriptionShape,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">  &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">  const childContextTypes = &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    [subscriptionKey]: subscriptionShape,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">  &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">  return function wrapWithConnect(WrappedComponent) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    /</span><span class="regexp">/ 如果不是生产环境,检测被HOC包裹的对象是否为合法的组件</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    if (process.env.NODE_ENV !== 'production') &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      invariant(</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        isValidElementType(WrappedComponent),</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        `You must pass a component to the function returned by ` +</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        `$&#123;methodName&#125;. Instead received $&#123;JSON.stringify(WrappedComponent)&#125;`</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      );</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    const wrappedComponentName = WrappedComponent.displayName</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      || WrappedComponent.name</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      || 'Component'</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    const displayName = getDisplayName(wrappedComponentName)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    /</span><span class="regexp">/ 要传给selectorFactory的参数</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    const selectorFactoryOptions = &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      /</span><span class="regexp">/ 用户要传入的参数</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      ...connectOptions,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      getDisplayName,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      methodName,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      renderCountProp,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      shouldHandleStateChanges,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      storeKey,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      withRef,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      displayName,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      wrappedComponentName,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      WrappedComponent</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    class Connect extends Component &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      constructor(props, context) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        super(props, context)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.version = version</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.state = &#123;&#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.renderCount = 0</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.store = props[storeKey] || context[storeKey]</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        /</span><span class="regexp">/ 从props是否传入了store</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.propsMode = Boolean(props[storeKey])</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        /</span><span class="regexp">/ for ref</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.setWrappedInstance = this.setWrappedInstance.bind(this)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        invariant(this.store,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          `Could not find "$&#123;storeKey&#125;" in either the context or props of ` +</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          `"$&#123;displayName&#125;". Either wrap the root component in a &lt;Provider&gt;, ` +</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          `or explicitly pass "$&#123;storeKey&#125;" as a prop to "$&#123;displayName&#125;".`</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        )</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.initSelector()</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.initSubscription()</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      getChildContext() &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        const subscription = this.propsMode ? null : this.subscription</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        return &#123; [subscriptionKey]: subscription || this.context[subscriptionKey] &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      componentDidMount() &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        if (!shouldHandleStateChanges) return</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.subscription.trySubscribe()</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.selector.run(this.props)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        if (this.selector.shouldComponentUpdate) this.forceUpdate()</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      componentWillReceiveProps(nextProps) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.selector.run(nextProps)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      shouldComponentUpdate() &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        return this.selector.shouldComponentUpdate</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      componentWillUnmount() &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        if (this.subscription) this.subscription.tryUnsubscribe()</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.subscription = null</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.notifyNestedSubs = noop</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.store = null</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.selector.run = noop</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.selector.shouldComponentUpdate = false</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      getWrappedInstance() &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        invariant(withRef,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          `To access the wrapped instance, you need to specify ` +</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          `&#123; withRef: true &#125; in the options argument of the $&#123;methodName&#125;() call.`</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        )</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        return this.wrappedInstance</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      setWrappedInstance(ref) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.wrappedInstance = ref</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      initSelector() &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        /</span><span class="regexp">/ 为selectorFactory注入dispatch</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        const sourceSelector = selectorFactory(this.store.dispatch, selectorFactoryOptions)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        /</span><span class="regexp">/ 为selector注入state,并通过mapstate计算nextProps来标记是否需要更新组件</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        /</span><span class="regexp">/ props和nextProps存储在selector中,在两次run时用来比较</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.selector = makeSelectorStateful(sourceSelector, this.store)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.selector.run(this.props)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      initSubscription() &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        /</span><span class="regexp">/ 不监听直接返回</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        if (!shouldHandleStateChanges) return</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        /</span><span class="regexp">/ 如果是props传来的store则从props订阅,如果不是则从context订阅</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        const parentSub = (this.propsMode ? this.props : this.context)[subscriptionKey]</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        /</span><span class="regexp">/ 为当前组件创建一个新的订阅</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.subscription = new Subscription(this.store, parentSub, this.onStateChange.bind(this))</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.notifyNestedSubs = this.subscription.notifyNestedSubs.bind(this.subscription)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      /</span><span class="regexp">/ state改变的回调</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      onStateChange() &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        /</span><span class="regexp">/ 比较props, 看是否需要更新组件</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.selector.run(this.props)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        /</span><span class="regexp">/ 如果props没变,不需要更新组件,则通知下边的组件store改变,检测是否需要更新</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        /</span><span class="regexp">/ 如果触发了更新,则通过setState强制更新,通过didupdate延后通知子组件检查更新</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        /</span><span class="regexp">/ !!!在本组件update之后,子组件实际已经update,所以在didupdate后通知子组件检查更新</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        /</span><span class="regexp">/ 并不会造成再次渲染子组件,不需要担心嵌套connect的性能问题</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        if (!this.selector.shouldComponentUpdate) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          this.notifyNestedSubs()</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        &#125; else &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          /</span><span class="regexp">/ 在didupdate延后通知子组件检查更新</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          this.componentDidUpdate = this.notifyNestedSubsOnComponentDidUpdate</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          this.setState(dummyState)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      notifyNestedSubsOnComponentDidUpdate() &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.componentDidUpdate = undefined</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        this.notifyNestedSubs()</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      isSubscribed() &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        return Boolean(this.subscription) &amp;&amp; this.subscription.isSubscribed()</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      addExtraProps(props) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        if (!withRef &amp;&amp; !renderCountProp &amp;&amp; !(this.propsMode &amp;&amp; this.subscription)) return props</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        const withExtras = &#123; ...props &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        if (withRef) withExtras.ref = this.setWrappedInstance</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        if (renderCountProp) withExtras[renderCountProp] = this.renderCount++</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        if (this.propsMode &amp;&amp; this.subscription) withExtras[subscriptionKey] = this.subscription</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        return withExtras</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      render() &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        const selector = this.selector</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        selector.shouldComponentUpdate = false</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        if (selector.error) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          throw selector.error</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        &#125; else &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          return createElement(WrappedComponent, this.addExtraProps(selector.props))</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    Connect.WrappedComponent = WrappedComponent</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    Connect.displayName = displayName</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    Connect.childContextTypes = childContextTypes</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    Connect.contextTypes = contextTypes</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    Connect.propTypes = contextTypes</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    if (process.env.NODE_ENV !== 'production') &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      Connect.prototype.componentWillUpdate = function componentWillUpdate() &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        /</span><span class="regexp">/ 处理热加载</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        /</span><span class="regexp">/ 如果版本号改变则说明出发了热加载</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        /</span><span class="regexp">/ 更新版本号</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        /</span><span class="regexp">/ 重新初始化订阅,并解除订阅后重新订阅原有订阅</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        if (this.version !== version) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          this.version = version</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          this.initSelector()</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          let oldListeners = [];</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          if (this.subscription) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">            oldListeners = this.subscription.listeners.get()</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">            this.subscription.tryUnsubscribe()</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          this.initSubscription()</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          if (shouldHandleStateChanges) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">            this.subscription.trySubscribe()</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">            oldListeners.forEach(listener =&gt; this.subscription.listeners.subscribe(listener))</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">          &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    return hoistStatics(Connect, WrappedComponent)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">  &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">&#125;</span></span></span></span><br></pre></td></tr></table></figure></p>
<h2 id="Subscription"><a href="#Subscription" class="headerlink" title="Subscription"></a>Subscription</h2><p>订阅的实现是整个框架实现的核心部分之一, 它让每个Container管理自己的一个订阅状态, 并通过将子树叶的订阅集中在父树叶处理,来确保每次state更新造成的dom更新是自上而下的,保证了子树叶不会重复更新<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// encapsulates the subscription logic for connecting a component to the redux store, as</span></span><br><span class="line"><span class="comment">// well as nesting subscriptions of descendant components, so that we can ensure the</span></span><br><span class="line"><span class="comment">// ancestor components re-render before descendants</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> CLEARED = <span class="literal">null</span></span><br><span class="line"><span class="keyword">const</span> nullListeners = &#123; notify() &#123;&#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createListenerCollection</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// the current/next pattern is copied from redux's createStore code.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> refactor+expose that code to be reusable here?</span></span><br><span class="line">  <span class="keyword">let</span> current = []</span><br><span class="line">  <span class="keyword">let</span> next = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    clear() &#123;</span><br><span class="line">      next = CLEARED</span><br><span class="line">      current = CLEARED</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    notify() &#123;</span><br><span class="line">      <span class="keyword">const</span> listeners = current = next</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; listeners.length; i++) &#123;</span><br><span class="line">        listeners[i]()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">get</span>() &#123;</span><br><span class="line">      <span class="keyword">return</span> next</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    subscribe(listener) &#123;</span><br><span class="line">      <span class="keyword">let</span> isSubscribed = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">if</span> (next === current) next = current.slice()</span><br><span class="line">      next.push(listener)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unsubscribe</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isSubscribed || current === CLEARED) <span class="keyword">return</span></span><br><span class="line">        isSubscribed = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (next === current) next = current.slice()</span><br><span class="line">        next.splice(next.indexOf(listener), <span class="number">1</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Subscription</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(store, parentSub, onStateChange) &#123;</span><br><span class="line">    <span class="keyword">this</span>.store = store</span><br><span class="line">    <span class="keyword">this</span>.parentSub = parentSub</span><br><span class="line">    <span class="keyword">this</span>.onStateChange = onStateChange</span><br><span class="line">    <span class="keyword">this</span>.unsubscribe = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.listeners = nullListeners</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  addNestedSub(listener) &#123;</span><br><span class="line">    <span class="keyword">this</span>.trySubscribe()</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.listeners.subscribe(listener)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  notifyNestedSubs() &#123;</span><br><span class="line">    <span class="keyword">this</span>.listeners.notify()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  isSubscribed() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Boolean</span>(<span class="keyword">this</span>.unsubscribe)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  trySubscribe() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.unsubscribe) &#123;</span><br><span class="line">      <span class="comment">// !!!划重点!敲黑板!</span></span><br><span class="line">      <span class="comment">// 没有父级观察者的话，直接监听store change</span></span><br><span class="line">      <span class="comment">// 有的话，添到父级下面，由父级传递变化</span></span><br><span class="line">      <span class="keyword">this</span>.unsubscribe = <span class="keyword">this</span>.parentSub</span><br><span class="line">        ? <span class="keyword">this</span>.parentSub.addNestedSub(<span class="keyword">this</span>.onStateChange)</span><br><span class="line">        : <span class="keyword">this</span>.store.subscribe(<span class="keyword">this</span>.onStateChange)</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">this</span>.listeners = createListenerCollection()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tryUnsubscribe() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.unsubscribe) &#123;</span><br><span class="line">      <span class="keyword">this</span>.unsubscribe()</span><br><span class="line">      <span class="keyword">this</span>.unsubscribe = <span class="literal">null</span></span><br><span class="line">      <span class="keyword">this</span>.listeners.clear()</span><br><span class="line">      <span class="keyword">this</span>.listeners = nullListeners</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/gabithume">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#api"><span class="toc-number">1.</span> <span class="toc-text">api</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Provider"><span class="toc-number">2.</span> <span class="toc-text">Provider</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#createProvider"><span class="toc-number">3.</span> <span class="toc-text">createProvider</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#connectAdvance"><span class="toc-number">4.</span> <span class="toc-text">connectAdvance</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Subscription"><span class="toc-number">5.</span> <span class="toc-text">Subscription</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/01/31/react-redux/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/01/31/react-redux/&text=react-redux 源码解析"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/01/31/react-redux/&title=react-redux 源码解析"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/01/31/react-redux/&is_video=false&description=react-redux 源码解析"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=react-redux 源码解析&body=Check out this article: http://yoursite.com/2019/01/31/react-redux/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/01/31/react-redux/&title=react-redux 源码解析"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/01/31/react-redux/&title=react-redux 源码解析"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/01/31/react-redux/&title=react-redux 源码解析"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/01/31/react-redux/&title=react-redux 源码解析"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/01/31/react-redux/&name=react-redux 源码解析&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$("#toc-footer").toggle();return false;"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$("#share-footer").toggle();return false;"><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$("#nav-footer").toggle();return false;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 Cao Yi
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/gabithume">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-86660611-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->


